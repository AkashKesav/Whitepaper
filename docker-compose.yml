version: "3.8"

services:
  # DGraph Zero - Cluster management
  dgraph-zero:
    image: dgraph/dgraph:v24.0.0
    container_name: rmk-dgraph-zero
    ports:
      - "5080:5080"
      - "6080:6080"
    volumes:
      - dgraph-zero-data:/dgraph
    command: dgraph zero --my=dgraph-zero:5080
    networks:
      - rmk-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # DGraph Alpha - Graph database
  dgraph-alpha:
    image: dgraph/dgraph:v24.0.0
    container_name: rmk-dgraph-alpha
    ports:
      - "8180:8080"
      - "9180:9080"
    volumes:
      - dgraph-alpha-data:/dgraph
    command: dgraph alpha --my=dgraph-alpha:7080 --zero=dgraph-zero:5080 --security whitelist=0.0.0.0/0
    networks:
      - rmk-network
    depends_on:
      dgraph-zero:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # NATS - Message queue for streaming
  nats:
    image: nats:2.10-alpine
    container_name: rmk-nats
    ports:
      - "4322:4222"
      - "8322:8222"
    command: [ "--jetstream", "--http_port", "8222" ]
    networks:
      - rmk-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis - Caching activation scores and hot paths
  redis:
    image: redis:7-alpine
    container_name: rmk-redis
    ports:
      - "6479:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - rmk-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # AI Services - Python FastAPI for SLM orchestration (NVIDIA NIM only)
  ai-services:
    build:
      context: ./ai
      dockerfile: Dockerfile
    container_name: rmk-ai-services
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    networks:
      - rmk-network

  # Ollama - Local LLM/Embedding service (replaces ONNX)
  ollama:
    image: ollama/ollama:latest
    container_name: rmk-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - rmk-network
    healthcheck:
      test: [ "CMD-SHELL", "ollama list || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Qdrant - Vector database for Hybrid RAG
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rmk-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - rmk-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Monolith - Unified Agent + Kernel (Quantum Architecture)
  monolith:
    build:
      context: .
      dockerfile: Dockerfile.monolith
    container_name: rmk-monolith
    ports:
      - "9090:9090"
    environment:
      - DGRAPH_ADDRESS=dgraph-alpha:9080
      - NATS_URL=nats://nats:4222
      - REDIS_ADDRESS=redis:6379
      - AI_SERVICES_URL=http://ai-services:8000
      - OLLAMA_URL=http://ollama:11434
      - QDRANT_URL=http://qdrant:6333
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - PORT=9090
    networks:
      - rmk-network
    depends_on:
      dgraph-alpha:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      ai-services:
        condition: service_started
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_healthy

volumes:
  dgraph-zero-data:
  dgraph-alpha-data:
  redis-data:
  ollama-data:
  qdrant-data:


networks:
  rmk-network:
    driver: bridge
