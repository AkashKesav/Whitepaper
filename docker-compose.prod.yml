version: "3.8"

# Minimal docker-compose for Railway or production deployment
# Uses external managed services for DGraph, Redis, and Qdrant

services:
  # Monolith - Unified Agent + Kernel + Frontend
  monolith:
    build:
      context: .
      dockerfile: Dockerfile.monolith
    container_name: rmk-monolith
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    environment:
      # Core Settings
      - PORT=${PORT:-8080}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production-32chars-minimum-length}

      # External Services (set these in Railway or .env)
      - DGRAPH_ADDRESS=${DGRAPH_ADDRESS:-localhost:9080}
      - REDIS_ADDRESS=${REDIS_ADDRESS:-${REDIS_URL:-localhost:6379}}
      - QDRANT_URL=${QDRANT_URL:-http://localhost:6333}
      - AI_SERVICES_URL=${AI_SERVICES_URL:-http://localhost:8000}
      - OLLAMA_URL=${OLLAMA_URL:-http://localhost:11434}

      # LLM API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GLM_API_KEY=${GLM_API_KEY:-}

      # CORS (for Railway custom domain)
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${PORT:-8080}/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # AI Services (Python) - Deploy separately on Railway if needed
  ai-services:
    build:
      context: ./ai
      dockerfile: Dockerfile
    container_name: rmk-ai-services
    ports:
      - "8000:8000"
    environment:
      - GLM_API_KEY=${GLM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OLLAMA_URL=${OLLAMA_URL:-http://localhost:11434}
    profiles:
      - ai # Only start with: docker-compose --profile ai up

networks:
  default:
    driver: bridge
